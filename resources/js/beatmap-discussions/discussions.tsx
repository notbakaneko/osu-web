// Copyright (c) ppy Pty Ltd <contact@ppy.sh>. Licensed under the GNU Affero General Public License v3.0.
// See the LICENCE file in the repository root for full licence text.

import IconExpand from 'components/icon-expand';
import BeatmapsetDiscussionJson, { BeatmapsetDiscussionJsonForShow } from 'interfaces/beatmapset-discussion-json';
import BeatmapsetDiscussionsStore from 'interfaces/beatmapset-discussions-store';
import { action, computed, makeObservable } from 'mobx';
import { observer } from 'mobx-react';
import * as React from 'react';
import { canModeratePosts } from 'utils/beatmapset-discussion-helper';
import { classWithModifiers } from 'utils/css';
import { trans } from 'utils/lang';
import { Discussion } from './discussion';
import DiscussionsState from './discussions-state';
import Sort, { sortPresets } from './sort';
import Toolbar from './toolbar';

const bn = 'beatmap-discussions';

interface Props {
  discussionsState: DiscussionsState;
  store: BeatmapsetDiscussionsStore;
}

@observer
export class Discussions extends React.Component<Props> {
  private get discussionsState() {
    return this.props.discussionsState;
  }

  @computed
  private get isTimelineVisible() {
    return this.discussionsState.currentPage === 'timeline' && this.discussionsState.currentSort === 'timeline';
  }

  private get store() {
    return this.props.store;
  }

  @computed
  private get sortedDiscussions() {
    if (this.discussionsState.currentPage === 'events') return [];

    const discussions = this.discussionsState.discussionsForSelectedUserByMode[this.discussionsState.currentPage];

    return discussions.slice().sort((a: BeatmapsetDiscussionJson, b: BeatmapsetDiscussionJson) => {
      const mapperNoteCompare =
        // no sticky for timeline sort
        this.discussionsState.currentSort !== 'timeline'
        // stick the mapper note
        && [a.message_type, b.message_type].includes('mapper_note')
        // but if both are mapper note, do base comparison
        && a.message_type !== b.message_type;

      if (mapperNoteCompare) {
        return a.message_type === 'mapper_note' ? -1 : 1;
      } else {
        return sortPresets[this.discussionsState.currentSort].sort(a, b);
      }
    });
  }

  constructor(props: Props) {
    super(props);
    makeObservable(this);
  }

  render() {
    return (
      <div className='osu-page osu-page--small osu-page--full'>
        <Toolbar discussionsState={this.props.discussionsState} store={this.props.store} />
        <div className={`${bn} js-beatmap-discussions`}>
          <div className='page-title'>
            {trans('beatmaps.discussions.title')}
          </div>
          <div className={`${bn}__toolbar`}>
            <div className={`${bn}__toolbar-content ${bn}__toolbar-content--left`}>
              <div className={`${bn}__toolbar-item`}>
                {this.renderSortOptions()}
              </div>
            </div>
            <div className={`${bn}__toolbar-content ${bn}__toolbar-content--right`}>
              {/* {this.renderUserFilterToggles()}
              {this.renderShowDeletedToggle()} */}
              {this.renderExpandCollapseAllButton('collapse')}
              {this.renderExpandCollapseAllButton('expand')}
            </div>
          </div>

          {this.renderDiscussions()}
        </div>
      </div>
    );
  }

  @action
  private readonly handleChangeSort = (e: React.SyntheticEvent<HTMLButtonElement>) => {
    if (this.discussionsState.currentPage === 'events') return;
    this.discussionsState.sort[this.discussionsState.currentPage] = e.currentTarget.dataset.sortPreset as Sort;
  };

  @action
  private readonly handleExpandClick = (e: React.SyntheticEvent<HTMLButtonElement>) => {
    this.discussionsState.discussionDefaultCollapsed = e.currentTarget.dataset.type === 'collapse';
    this.discussionsState.discussionCollapsed.clear();
  };

  private readonly renderDiscussionPage = (discussion: BeatmapsetDiscussionJsonForShow) => {
    const parentDiscussion = this.store.discussions.get(discussion.parent_id);

    return (
      <Discussion
        key={discussion.id}
        discussion={discussion}
        discussionsState={this.discussionsState}
        isTimelineVisible={this.isTimelineVisible}
        parentDiscussion={parentDiscussion?.message_type === 'review' ? parentDiscussion : null}
        store={this.store}
      />
    );
  };

  private renderDiscussions() {
    const count = this.sortedDiscussions.length;

    if (count === 0) {
      return (
        <div className={`${bn}__discussions ${bn}__discussions--empty`}>
          {this.discussionsState.discussionsByFilter.total.length > count
            ? trans('beatmaps.discussions.empty.hidden')
            : trans('beatmaps.discussions.empty.empty')
          }
        </div>
      );
    }

    return (
      <div className={`${bn}__discussions`}>
        {this.renderTimelineCircle()}

        {this.isTimelineVisible && <div className={`${bn}__timeline-line hidden-xs`} />}

        {this.sortedDiscussions.map(this.renderDiscussionPage)}

        {this.renderTimelineCircle()}
      </div>
    );
  }

  private renderExpandCollapseAllButton(type: 'collapse' | 'expand') {
    return (
      <button
        className={`${bn}__toolbar-item ${bn}__toolbar-item--link`}
        data-type={type}
        onClick={this.handleExpandClick}
        type='button'
      >
        <IconExpand expand={type === 'expand'} parentClass={`${bn}__toolbar-link-content`} />
        <span className={`${bn}__toolbar-link-content`}>
          {trans(`beatmaps.discussions.collapse.all-${type}`)}
        </span>
      </button>
    );
  }

  private renderShowDeletedToggle() {
    if (!canModeratePosts()) return null;

    return (
      <button
        className={`${bn}__toolbar-item ${bn}__toolbar-item--link`}
        onClick={this.toggleShowDeleted}
        type='button'
      >
        <span className={`${bn}__toolbar-link-content`}>
          <span className={this.discussionsState.showDeleted ? 'fas fa-check-square' : 'far fa-square'} />
        </span>
        <span className={`${bn}__toolbar-link-content`}>
          {trans('beatmaps.discussions.show_deleted')}
        </span>
      </button>
    );
  }

  private renderSortOptions() {
    const presets: Sort[] = this.discussionsState.currentPage === 'timeline'
      ? ['timeline', 'updated_at']
      : ['created_at', 'updated_at'];

    return (
      <div className='sort sort--beatmapset-discussions'>
        <div className='sort__items'>
          <span className='sort__item sort__item--title'>{trans('sort._')}</span>
          {presets.map((preset) => (
            <button
              key={preset}
              className={classWithModifiers('sort__item', 'button', { active: this.discussionsState.currentSort === preset })}
              data-sort-preset={preset}
              onClick={this.handleChangeSort}
              type='button'
            >
              {sortPresets[preset].text}
            </button>
          ))}
        </div>
      </div>
    );
  }

  private renderTimelineCircle() {
    return (
      <div
        className={`${bn}__mode-circle ${bn}__mode-circle--active hidden-xs`}
        data-visibility={!this.isTimelineVisible ? 'hidden' : undefined}
      />
    );
  }

  private renderUserFilterToggles() {
    if (this.discussionsState.selectedUserId == null) return null;

    return (
      <>
        <button
          className={`${bn}__toolbar-item ${bn}__toolbar-item--link`}
          onClick={this.toggleIncludeReplies}
          type='button'
        >
          <span className={`${bn}__toolbar-link-content`}>
            <span className={this.discussionsState.selectedUserIncludeReplies ? 'fas fa-check-square' : 'far fa-square'} />
          </span>
          <span className={`${bn}__toolbar-link-content`}>
            {trans('beatmaps.discussions.include_replies')}
          </span>
        </button>
        <button
          className={`${bn}__toolbar-item ${bn}__toolbar-item--link`}
          onClick={this.toggleShowOtherReplies}
          type='button'
        >
          <span className={`${bn}__toolbar-link-content`}>
            <span className={this.discussionsState.showOtherReplies ? 'fas fa-check-square' : 'far fa-square'} />
          </span>
          <span className={`${bn}__toolbar-link-content`}>
            {trans('beatmaps.discussions.show_other_replies')}
          </span>
        </button>
      </>
    );
  }

  @action
  private readonly toggleIncludeReplies = () => {
    this.discussionsState.selectedUserIncludeReplies = !this.discussionsState.selectedUserIncludeReplies;
  };

  @action
  private readonly toggleShowDeleted = () => {
    this.discussionsState.showDeleted = !this.discussionsState.showDeleted;
  };

  @action
  private readonly toggleShowOtherReplies = () => {
    this.discussionsState.showOtherReplies = !this.discussionsState.showOtherReplies;
  };
}
